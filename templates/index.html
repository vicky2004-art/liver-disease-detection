import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.tree import DecisionTreeClassifier, plot_tree
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score

# --- PAGE CONFIGURATION ---
st.set_page_config(page_title="Liver Disease AI", layout="centered")

# --- HEADER ---
st.title("üè• Liver Disease Detection AI")
st.write("This system uses a **Decision Tree Classifier** to predict liver disease based on clinical data.")

# --- LOAD AND TRAIN MODEL (Cached for Speed) ---
@st.cache_resource
def load_and_train_model():
    try:
        # Load Data
        df = pd.read_csv('Liver Patient Dataset (LPD)_train.csv', encoding='latin1')
        
        # Rename Columns
        df.columns = ['Age', 'Gender', 'Total_Bilirubin', 'Direct_Bilirubin', 
                      'Alkaline_Phosphotase', 'Alamine_Aminotransferase', 
                      'Aspartate_Aminotransferase', 'Total_Protiens', 
                      'Albumin', 'Albumin_and_Globulin_Ratio', 'Result']

        # Cleaning
        numerical_cols = df.select_dtypes(include=['number']).columns
        df[numerical_cols] = df[numerical_cols].fillna(df[numerical_cols].mean())
        df['Gender'] = df['Gender'].fillna(df['Gender'].mode()[0])
        df['Gender'] = df['Gender'].map({'Male': 1, 'Female': 0})
        df['Result'] = df['Result'].map({1: 1, 2: 0}) # 1=Disease, 0=Healthy

        # Split
        X = df.drop('Result', axis=1)
        y = df['Result']
        
        X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
        
        # Train
        model = DecisionTreeClassifier(max_depth=4, criterion='entropy', random_state=42)
        model.fit(X_train, y_train)
        
        accuracy = accuracy_score(y_test, model.predict(X_test))
        return model, accuracy, X.columns.tolist()

    except FileNotFoundError:
        return None, None, None

model, accuracy, feature_names = load_and_train_model()

# --- ERROR HANDLING ---
if model is None:
    st.error("üö® CRITICAL ERROR: Dataset not found!")
    st.warning("Please make sure 'Liver Patient Dataset (LPD)_train.csv' is in the same folder as this script.")
    st.stop() # Stop execution here

st.success(f"‚úÖ Model Trained Successfully! Accuracy: {accuracy*100:.2f}%")

# --- USER INPUT FORM ---
st.sidebar.header("Patient Data Entry")
st.sidebar.write("Enter the clinical values below:")

def user_input_features():
    name = st.sidebar.text_input("Patient Name", "John Doe")
    age = st.sidebar.number_input("Age", 1, 100, 45)
    gender = st.sidebar.selectbox("Gender", ("Male", "Female"))
    weight = st.sidebar.number_input("Weight (kg)", 0.0, 200.0, 70.0) # Not used in model but requested
    
    # Clinical Features
    tb = st.sidebar.number_input("Total Bilirubin", 0.0, 50.0, 0.7)
    db = st.sidebar.number_input("Direct Bilirubin", 0.0, 30.0, 0.1)
    alkphos = st.sidebar.number_input("Alkaline Phosphotase", 0.0, 2000.0, 187.0)
    sgpt = st.sidebar.number_input("Alamine Aminotransferase", 0.0, 2000.0, 16.0)
    sgot = st.sidebar.number_input("Aspartate Aminotransferase", 0.0, 2000.0, 18.0)
    tp = st.sidebar.number_input("Total Proteins", 0.0, 15.0, 6.8)
    alb = st.sidebar.number_input("Albumin", 0.0, 10.0, 3.3)
    ag = st.sidebar.number_input("A/G Ratio", 0.0, 5.0, 0.9)

    gender_enc = 1 if gender == "Male" else 0
    
    data = {
        'Age': age,
        'Gender': gender_enc,
        'Total_Bilirubin': tb,
        'Direct_Bilirubin': db,
        'Alkaline_Phosphotase': alkphos,
        'Alamine_Aminotransferase': sgpt,
        'Aspartate_Aminotransferase': sgot,
        'Total_Protiens': tp,
        'Albumin': alb,
        'Albumin_and_Globulin_Ratio': ag
    }
    features = pd.DataFrame(data, index=[0])
    return features, name

input_df, patient_name = user_input_features()

# --- PREDICTION BUTTON ---
st.subheader(f"Results for: {patient_name}")
st.write("Current Patient Vitals:")
st.dataframe(input_df)

if st.button("üîç Analyze Symptoms"):
    prediction = model.predict(input_df)
    
    if prediction[0] == 1:
        st.error("‚ö†Ô∏è POSITIVE: Liver Disease Detected")
        st.write("**Recommendation:** Please consult a hepatologist for further testing immediately.")
    else:
        st.balloons()
        st.success("‚úÖ NEGATIVE: No Liver Disease Detected")
        st.write("**Recommendation:** The patient appears healthy. Maintain a balanced diet.")

# --- VISUALIZATION ---
st.markdown("---")
st.subheader("üå≥ Decision Tree Visualization")
if st.checkbox("Show Decision Tree Diagram"):
    fig, ax = plt.subplots(figsize=(25, 12))
    plot_tree(model, feature_names=feature_names, class_names=['Healthy', 'Disease'], filled=True, rounded=True, fontsize=10)
    st.pyplot(fig)